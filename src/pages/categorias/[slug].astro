---
import BaseLayout from '@layouts/BaseLayout.astro';
import BookCover from '@components/BookCover.astro';
import { supabase } from '@lib/supabase';
import { formatPrice } from '@utils/formatting';

// 1. Generación de Rutas Estáticas (SSG)
export async function getStaticPaths() {
  const { data: categories } = await supabase
    .from('categories')
    .select('slug');

  return categories?.map((cat) => ({
    params: { slug: cat.slug },
  })) || [];
}

// 2. Obtención de Datos de la Categoría y sus Productos
const { slug } = Astro.params;

// Primero obtenemos la info de la categoría actual
const { data: category } = await supabase
  .from('categories')
  .select('id, name')
  .eq('slug', slug)
  .single();

if (!category) {
  return Astro.redirect('/404');
}

// Luego buscamos los libros que pertenecen a esta categoría
const { data: products } = await supabase
  .from('products')
  .select('id, title, author, price, slug, cover_image')
  .eq('category_id', category.id)
  .eq('status', 'active')
  .order('created_at', { ascending: false });
---

<BaseLayout 
  title={`${category.name} | BiblioFlow`} 
  description={`Explora nuestra selección de libros sobre ${category.name}.`}
>
  
  <section class="py-12 md:py-20 text-center space-y-4 animate-fade-in">
    <nav class="flex justify-center text-sm text-brand-ink/50 font-medium mb-4">
      <a href="/" class="hover:text-brand-ink transition-colors">Inicio</a>
      <span class="mx-2">/</span>
      <span class="text-brand-ink">Categorías</span>
    </nav>

    <h1 class="text-4xl md:text-5xl font-serif font-bold text-brand-ink capitalize">
      {category.name}
    </h1>
    <p class="text-lg text-brand-ink/60 max-w-2xl mx-auto">
      {products?.length} libros disponibles en esta colección.
    </p>
  </section>

  <section class="pb-20">
    {products && products.length > 0 ? (
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-10">
        {products.map((book) => (
          <a href={`/libros/${book.slug}`} class="group block space-y-3">
            
            <div class="shadow-md transition-shadow duration-300 group-hover:shadow-xl group-hover:-translate-y-1 rounded-sm">
                <div style={`view-transition-name: book-${book.slug}`}>
                    <BookCover 
                        src={book.cover_image} 
                        alt={`Portada de ${book.title}`} 
                        title={book.title}
                    />
                </div>
            </div>

            <div>
              <h3 class="font-bold text-brand-ink leading-tight group-hover:text-brand-ink/80 transition-colors">
                {book.title}
              </h3>
              <p class="text-sm text-brand-ink/60">{book.author}</p>
              <p class="text-sm font-medium text-brand-ink mt-1">
                {formatPrice(book.price)}
              </p>
            </div>
          </a>
        ))}
      </div>
    ) : (
      <div class="py-20 text-center border-2 border-dashed border-brand-ink/10 rounded-lg">
        <p class="text-brand-ink/50">Aún no hay libros en esta categoría.</p>
      </div>
    )}
  </section>

</BaseLayout>
